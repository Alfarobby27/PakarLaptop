{% extends "base.html" %} {% block content %}

<div class="max-w-6xl mx-auto space-y-10">
  <!-- ================= HEADER ================= -->
  <div>
    <h3 class="text-3xl font-bold text-white mb-2">Proses Forward Chaining</h3>
    <p class="text-slate-400">
      Proses penalaran berbasis rule (data-driven reasoning).
    </p>
  </div>

  <!-- ================= INFO AWAL ================= -->
  <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 space-y-4">
    <div>
      <span class="font-semibold text-slate-300">Mode Evaluasi:</span>
      <span
        class="ml-2 px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-sm"
      >
        {{ mode_label }}
      </span>
    </div>

    <div>
      <span class="font-semibold text-slate-300">Fakta Awal:</span>
      <div class="mt-2 flex flex-wrap gap-2">
        {% for g in selected_symptoms %}
        <span class="px-3 py-2 bg-slate-700 rounded text-xs text-slate-200">
          <strong>{{ g }}</strong> — {{ SYMPTOMS[g] }}
        </span>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ================= TABEL INFERENSI ================= -->
  <div
    class="bg-slate-800 border border-slate-700 rounded-xl p-6 overflow-x-auto"
  >
    <h4 class="text-xl font-semibold text-white mb-6">
      Tabel Proses Inferensi
    </h4>

    {% if process_log %}

    <table class="w-full border-collapse text-sm text-slate-300">
      <thead class="bg-slate-900 text-slate-200">
        <tr>
          <th class="border border-slate-700 px-3 py-2">Step</th>
          <th class="border border-slate-700 px-3 py-2">Rule</th>
          <th class="border border-slate-700 px-3 py-2">IF (Premis)</th>
          <th class="border border-slate-700 px-3 py-2">THEN</th>
          <th class="border border-slate-700 px-3 py-2">Status</th>
          <th class="border border-slate-700 px-3 py-2">Fakta Sebelum</th>
          <th class="border border-slate-700 px-3 py-2">Fakta Sesudah</th>
        </tr>
      </thead>
      <tbody>
        {% for step in process_log %}
        <tr class="hover:bg-slate-700/40 transition">
          <!-- STEP -->
          <td class="border border-slate-700 px-3 py-2 text-center">
            {{ step.step }}
          </td>

          <!-- RULE -->
          <td
            class="border border-slate-700 px-3 py-2 text-center font-semibold"
          >
            {{ step.rule }}
          </td>

          <!-- IF -->
          <td class="border border-slate-700 px-3 py-2">
            {% for c in step.if_condition %} {{ c }}{% if not loop.last %} {{
            mode }} {% endif %} {% endfor %}
          </td>

          <!-- THEN -->
          <td class="border border-slate-700 px-3 py-2 text-emerald-400">
            {{ step.then_code }}
          </td>

          <!-- STATUS -->
          <td class="border border-slate-700 px-3 py-2 text-center">
            {% if step.status %}
            <span
              class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold"
            >
              TRUE
            </span>
            {% else %}
            <span
              class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold"
            >
              FALSE
            </span>
            {% endif %}
          </td>

          <!-- FAKTA SEBELUM -->
          <td class="border border-slate-700 px-3 py-2">
            {{ step.facts_before | join(", ") }}
          </td>

          <!-- FAKTA SESUDAH -->
          <td class="border border-slate-700 px-3 py-2">
            {{ step.facts_after | join(", ") }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mt-6 text-center text-emerald-400 text-sm">
      Inferensi berhenti karena tidak ada fakta baru yang dapat ditambahkan
      lagi.
    </div>

    {% else %}
    <p class="text-slate-400 italic">Tidak terdapat proses inferensi.</p>
    {% endif %}
  </div>

  <!-- ================= KESIMPULAN ================= -->
  <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-6">
    <h4 class="text-xl font-bold text-white mb-4">Kesimpulan Akhir</h4>
    {% if final_fault %}

    <div class="text-emerald-400 font-bold text-lg mb-2">
      {{ final_fault.code }} — {{ final_fault.name }}
    </div>

    <div class="text-slate-300">
      <strong>Solusi:</strong>
      <p class="mt-1">{{ final_fault.solution }}</p>
    </div>

    {% elif diagnosis_message %}

    <p class="text-slate-300 italic">{{ diagnosis_message }}</p>

    {% else %}

    <p class="text-slate-300 italic">
      Tidak ditemukan kesimpulan berdasarkan fakta yang diberikan.
    </p>

    {% endif %}
  </div>

  <!-- ================= ACTION ================= -->
  <div class="flex justify-center">
    <a
      href="/diagnose-start"
      class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow transition"
    >
      Kembali ke Diagnosa
    </a>
  </div>
</div>

{% endblock %}
