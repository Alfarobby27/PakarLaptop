{% extends "base.html" %} {% block content %}

<div class="max-w-6xl mx-auto px-4 space-y-10">
  <!-- ================= HEADER ================= -->
  <div class="text-center">
    <h3 class="text-3xl sm:text-4xl font-bold text-white mb-2">
      Form Diagnosa Kerusakan Laptop
    </h3>
    <p class="text-slate-400 text-sm sm:text-base">
      Pilih gejala sebagai <strong>fakta awal (working memory)</strong>. Sistem
      akan melakukan inferensi menggunakan metode
      <strong>Forward Chaining (Data-Driven Reasoning)</strong>.
    </p>
  </div>

  <!-- ================= FORM ================= -->
  <form
    method="POST"
    action="{{ url_for('hasil_diagnosa') }}"
    id="diagnoseForm"
    class="space-y-8"
  >
    <!-- ================= MODE ================= -->
    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6">
      <h4 class="text-lg font-semibold text-white mb-4">
        ‚öôÔ∏è Mode Evaluasi Global
      </h4>

      <p class="text-xs text-slate-400 mb-4 leading-relaxed">
        Mode menentukan bagaimana <strong>mesin inferensi</strong>
        mengevaluasi premis rule saat proses Forward Chaining berlangsung.
        <br /><br />
        <strong>Struktur rule tetap bersifat konjungtif (AND)</strong>, namun
        engine dapat mengevaluasi secara:
        <br />
        ‚Ä¢ <strong>AND</strong> ‚Üí semua premis harus terpenuhi
        <br />
        ‚Ä¢ <strong>OR</strong> ‚Üí minimal satu premis terpenuhi
      </p>

      <div class="flex flex-col sm:flex-row gap-6">
        <label class="flex items-center gap-3 cursor-pointer">
          <input
            type="radio"
            name="mode"
            value="AND"
            checked
            class="w-5 h-5 accent-blue-500"
          />
          <span class="text-slate-200">
            AND (Semua premis harus terpenuhi)
          </span>
        </label>

        <label class="flex items-center gap-3 cursor-pointer">
          <input
            type="radio"
            name="mode"
            value="OR"
            class="w-5 h-5 accent-blue-500"
          />
          <span class="text-slate-200">
            OR (Minimal satu premis terpenuhi)
          </span>
        </label>
      </div>
    </div>

    <!-- ================= RULE HELPER ================= -->
    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6">
      <h4 class="text-lg font-semibold text-white mb-2">
        üîé Bantuan Pemilihan Gejala Berdasarkan Rule
      </h4>

      <p class="text-xs text-slate-400 mb-4">
        Tombol berikut hanya membantu memilih gejala sesuai premis rule. Proses
        inferensi tetap dilakukan sepenuhnya oleh engine Forward Chaining.
      </p>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for rule, rule_data in rules.items() %}
        <button
          type="button"
          data-symptoms="{{ rule_data['if'] | join(',') }}"
          class="rule-btn rounded-xl border border-slate-600 p-4 bg-slate-900 text-slate-200 hover:bg-blue-600/20 transition"
        >
          <div class="flex items-center justify-between">
            <span class="text-lg font-bold">{{ rule }}</span>
            <span class="text-xs px-2 py-1 rounded-full bg-slate-700">
              {{ rule_data['if'] | length }} Premis
            </span>
          </div>

          <p class="text-xs text-slate-400 mt-2">
            IF {% for p in rule_data['if'] %} {{ p }}{% if not loop.last %} AND
            {% endif %} {% endfor %} ‚Üí {{ rule_data['then'] }}
          </p>
        </button>
        {% endfor %}

        <button
          type="button"
          id="resetBtn"
          class="rounded-xl border border-red-500/40 p-4 bg-red-500/10 hover:bg-red-500/30 text-red-400 transition"
        >
          Reset
        </button>
      </div>
    </div>

    <!-- ================= GEJALA TABLE ================= -->
    <div
      class="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden"
    >
      <table class="w-full">
        <thead class="bg-slate-900">
          <tr>
            <th class="px-6 py-4 text-slate-300">Pilih</th>
            <th class="px-6 py-4 text-slate-300">Kode</th>
            <th class="px-6 py-4 text-slate-300">Gejala (Fakta)</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
          {% for code, name in symptoms.items() %}
          <tr data-code="{{ code }}" class="hover:bg-slate-700/50 transition">
            <td class="px-6 py-4 text-center">
              <input
                type="checkbox"
                name="symptoms"
                value="{{ code }}"
                class="symptom-checkbox w-5 h-5 accent-blue-500"
              />
            </td>

            <td class="px-6 py-4">
              <span
                class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-sm"
              >
                {{ code }}
              </span>
            </td>

            <td class="px-6 py-4 text-slate-200">{{ name }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ================= WARNING ================= -->
    <div
      id="warningMessage"
      class="hidden bg-amber-900/20 border border-amber-500/30 rounded-xl p-4"
    >
      <p class="text-amber-400 font-medium text-sm">
        ‚ö† Pilih minimal satu gejala untuk memulai proses inferensi.
      </p>
    </div>

    <!-- ================= ACTION ================= -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <button
        type="submit"
        class="px-10 py-4 bg-blue-600 hover:bg-blue-500 text-white text-lg font-semibold rounded-xl shadow-lg transition"
      >
        Proses Inferensi
      </button>

      <a
        href="{{ url_for('index') }}"
        class="px-10 py-4 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-xl text-center"
      >
        Kembali
      </a>
    </div>
  </form>
</div>

<!-- ================= SCRIPT ================= -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const ruleButtons = document.querySelectorAll(".rule-btn");
    const checkboxes = document.querySelectorAll(".symptom-checkbox");
    const resetBtn = document.getElementById("resetBtn");
    const form = document.getElementById("diagnoseForm");
    const warning = document.getElementById("warningMessage");

    function highlightRow(code, state) {
      const row = document.querySelector(`[data-code="${code}"]`);
      if (row) row.classList.toggle("bg-blue-600/10", state);
    }

    checkboxes.forEach((cb) => {
      cb.addEventListener("change", () => {
        highlightRow(cb.value, cb.checked);
      });
    });

    ruleButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        ruleButtons.forEach((b) =>
          b.classList.remove("ring-2", "ring-blue-500", "bg-blue-600/20"),
        );

        btn.classList.add("ring-2", "ring-blue-500", "bg-blue-600/20");

        const selected = (btn.dataset.symptoms || "").split(",");

        checkboxes.forEach((cb) => {
          cb.checked = selected.includes(cb.value);
          highlightRow(cb.value, cb.checked);
        });
      });
    });

    resetBtn.addEventListener("click", () => {
      ruleButtons.forEach((b) =>
        b.classList.remove("ring-2", "ring-blue-500", "bg-blue-600/20"),
      );

      checkboxes.forEach((cb) => {
        cb.checked = false;
        highlightRow(cb.value, false);
      });

      warning.classList.add("hidden");
    });

    form.addEventListener("submit", (e) => {
      const anyChecked = [...checkboxes].some((cb) => cb.checked);
      if (!anyChecked) {
        e.preventDefault();
        warning.classList.remove("hidden");
        warning.scrollIntoView({ behavior: "smooth" });
      }
    });
  });
</script>

{% endblock %}
